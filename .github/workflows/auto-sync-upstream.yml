name: Auto Sync Upstream

on:
  schedule:
    # æ¯å¤© UTC 2:00 (åŒ—äº¬æ—¶é—´ 10:00) è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸
    - cron: '0 2 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ï¼Œä»¥ä¾¿æ­£ç¡®åˆå¹¶
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/lbjlaq/Antigravity-Manager.git || true
          git fetch upstream

      - name: Check for updates
        id: check
        run: |
          # æ£€æŸ¥ä¸Šæ¸¸æ˜¯å¦æœ‰æ–°æäº¤
          UPSTREAM_COMMIT=$(git rev-parse upstream/main)
          CURRENT_COMMIT=$(git rev-parse HEAD)

          echo "upstream_commit=$UPSTREAM_COMMIT" >> $GITHUB_OUTPUT
          echo "current_commit=$CURRENT_COMMIT" >> $GITHUB_OUTPUT

          if [ "$UPSTREAM_COMMIT" != "$CURRENT_COMMIT" ]; then
            # æ£€æŸ¥æ˜¯å¦æœ‰å†²çªï¼ˆæŽ’é™¤æˆ‘ä»¬è‡ªå®šä¹‰çš„æ–‡ä»¶ï¼‰
            BEHIND_COUNT=$(git rev-list --count HEAD..upstream/main)
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "behind_count=$BEHIND_COUNT" >> $GITHUB_OUTPUT
            echo "âœ… å‘çŽ° $BEHIND_COUNT ä¸ªæ–°æäº¤éœ€è¦åŒæ­¥"
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "âœ… å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€åŒæ­¥"
          fi

      - name: Backup custom files
        if: steps.check.outputs.has_updates == 'true'
        run: |
          # å¤‡ä»½è‡ªå®šä¹‰æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
          mkdir -p /tmp/custom-backup

          # å¤‡ä»½ daily-build.ymlï¼ˆæˆ‘ä»¬çš„è‡ªå®šä¹‰ç¼–è¯‘é…ç½®ï¼‰
          if [ -f ".github/workflows/daily-build.yml" ]; then
            cp .github/workflows/daily-build.yml /tmp/custom-backup/
            echo "âœ… å·²å¤‡ä»½ daily-build.yml"
          fi

          # å¦‚æžœæœ‰å…¶ä»–è‡ªå®šä¹‰æ–‡ä»¶ï¼Œåœ¨è¿™é‡Œæ·»åŠ å¤‡ä»½
          # cp other-custom-file /tmp/custom-backup/

      - name: Sync with upstream
        if: steps.check.outputs.has_updates == 'true'
        run: |
          # æ–¹å¼1: å°è¯•æ­£å¸¸åˆå¹¶
          if git merge upstream/main --no-edit -m "chore: sync with upstream $(git rev-parse --short upstream/main)"; then
            echo "âœ… æˆåŠŸé€šè¿‡ merge åŒæ­¥ä¸Šæ¸¸æ›´æ–°"
            echo "sync_method=merge" >> $GITHUB_ENV
          else
            echo "âš ï¸ Merge å¤±è´¥ï¼Œå°è¯• rebase..."
            git merge --abort || true

            # æ–¹å¼2: ä½¿ç”¨ rebase
            if git rebase upstream/main; then
              echo "âœ… æˆåŠŸé€šè¿‡ rebase åŒæ­¥ä¸Šæ¸¸æ›´æ–°"
              echo "sync_method=rebase" >> $GITHUB_ENV
            else
              echo "âŒ Rebase ä¹Ÿå¤±è´¥äº†ï¼Œä½¿ç”¨å¼ºåˆ¶é‡ç½®ç­–ç•¥"
              git rebase --abort || true

              # æ–¹å¼3: å¼ºåˆ¶é‡ç½®åˆ°ä¸Šæ¸¸ï¼ˆä¿ç•™è‡ªå®šä¹‰æ–‡ä»¶ï¼‰
              git reset --hard upstream/main
              echo "âœ… å·²å¼ºåˆ¶é‡ç½®åˆ°ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬"
              echo "sync_method=reset" >> $GITHUB_ENV
            fi
          fi

      - name: Restore custom files
        if: steps.check.outputs.has_updates == 'true'
        run: |
          # æ¢å¤è‡ªå®šä¹‰æ–‡ä»¶
          if [ -f "/tmp/custom-backup/daily-build.yml" ]; then
            mkdir -p .github/workflows
            cp /tmp/custom-backup/daily-build.yml .github/workflows/
            echo "âœ… å·²æ¢å¤ daily-build.yml"

            # å¦‚æžœæ–‡ä»¶æœ‰å˜åŒ–ï¼Œæäº¤å®ƒ
            if ! git diff --quiet .github/workflows/daily-build.yml; then
              git add .github/workflows/daily-build.yml
              git commit -m "chore: restore custom daily-build workflow for Windows ARM64 support" || true
            fi
          fi

          # æ¢å¤å…¶ä»–è‡ªå®šä¹‰æ–‡ä»¶
          # if [ -f "/tmp/custom-backup/other-file" ]; then
          #   cp /tmp/custom-backup/other-file path/to/restore/
          #   git add path/to/restore/other-file
          #   git commit -m "chore: restore custom configuration" || true
          # fi

      - name: Push changes
        if: steps.check.outputs.has_updates == 'true'
        run: |
          # å¼ºåˆ¶æŽ¨é€åˆ° originï¼ˆå› ä¸ºå¯èƒ½ä½¿ç”¨äº† reset æˆ– rebaseï¼‰
          if [ "${{ env.sync_method }}" = "reset" ] || [ "${{ env.sync_method }}" = "rebase" ]; then
            git push origin main --force
            echo "âœ… å·²å¼ºåˆ¶æŽ¨é€æ›´æ–°åˆ° origin/main"
          else
            git push origin main
            echo "âœ… å·²æŽ¨é€æ›´æ–°åˆ° origin/main"
          fi

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ”„ åŒæ­¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check.outputs.has_updates }}" = "true" ]; then
            echo "### âœ… åŒæ­¥æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **åŒæ­¥æ–¹æ³•**: ${{ env.sync_method }}" >> $GITHUB_STEP_SUMMARY
            echo "- **ä¸Šæ¸¸æäº¤**: \`${{ steps.check.outputs.upstream_commit }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **è½åŽæäº¤æ•°**: ${{ steps.check.outputs.behind_count }}" >> $GITHUB_STEP_SUMMARY
            echo "- **è‡ªå®šä¹‰æ–‡ä»¶**: daily-build.yml (å·²ä¿ç•™)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### â„¹ï¸ æ— éœ€åŒæ­¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬" >> $GITHUB_STEP_SUMMARY
          fi
